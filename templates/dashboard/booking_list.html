{% extends 'dashboard/base_dashboard.html' %}

{% block title %}{{ title }}{% endblock %}
{% block page_title %}‰∫àÁ¥Ñ‰∏ÄË¶ß{% endblock %}

{% block content %}
<!-- „Éï„Ç£„É´„Çø„Éº -->
<div class="card">
    <div class="card-header">
        <h3>‰∫àÁ¥ÑÊ§úÁ¥¢„Éª„Éï„Ç£„É´„Çø„Éº</h3>
    </div>
    <div class="card-body">
        <form method="get" style="display: flex; gap: 1rem; align-items: end; flex-wrap: wrap;">
            <div class="form-group" style="margin-bottom: 0;">
                <label for="status">„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                <select name="status" id="status" class="form-control">
                    <option value="">„Åô„Åπ„Å¶</option>
                    {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if value == current_status %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label for="date">‰∫àÁ¥ÑÊó•</label>
                <input type="date" name="date" id="date" value="{{ current_date }}" class="form-control">
            </div>
            <button type="submit" class="btn btn-primary">Áµû„ÇäËæº„Åø</button>
            <a href="{% url 'dashboard:booking_list' %}" class="btn btn-secondary">„É™„Çª„ÉÉ„Éà</a>
        </form>
    </div>
</div>

<!-- ‰∫àÁ¥Ñ‰∏ÄË¶ß -->
<div class="card">
    <div class="card-header">
        <h3>‰∫àÁ¥Ñ‰∏ÄË¶ß ({{ bookings.count }}‰ª∂)</h3>
        <a href="{% url 'dashboard:booking_create' %}" class="btn btn-primary">Êñ∞Ë¶è‰∫àÁ¥ÑÁôªÈå≤</a>
    </div>
    <div class="card-body">
        {% if bookings %}
            <table class="table">
                <thead>
                    <tr>
                        <th>‰∫àÁ¥ÑÊó•ÊôÇ</th>
                        <th>„ÅäÂÆ¢ÊßòÊÉÖÂ†±</th>
                        <th>„Çµ„Éº„Éì„Çπ</th>
                        <th>ÊñôÈáë</th>
                        <th>„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                        <th>Áî≥ËæºÊó•</th>
                        <th>„Ç¢„ÇØ„Ç∑„Éß„É≥</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in bookings %}
                    <tr>
                        <td>
                            <strong>{{ booking.booking_date|date:"Y/m/d (D)" }}</strong><br>
                            {{ booking.booking_time }}
                        </td>
                        <td>
                            <!-- ‚òÖ ‰øÆÊ≠£: ÊÄßÂà•„Ç¢„Ç§„Ç≥„É≥„Å®È°ßÂÆ¢Âêç„ÇíË°®Á§∫ -->
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                {% if booking.customer.gender == 'male' %}
                                    <span style="font-size: 16px; color: #007bff;" title="Áî∑ÊÄß">üë®</span>
                                {% elif booking.customer.gender == 'female' %}
                                    <span style="font-size: 16px; color: #e91e63;" title="Â•≥ÊÄß">üë©</span>
                                {% else %}
                                    <span style="font-size: 14px; color: #6c757d;" title="ÊÄßÂà•Êú™Ë®≠ÂÆö">‚ùì</span>
                                {% endif %}
                                <strong>{{ booking.customer.name }}</strong>
                            </div>
                            
                            <!-- ‚òÖ ‰øÆÊ≠£: Âà©Áî®Áä∂Ê≥Å„Éê„ÉÉ„Ç∏„ÇíËøΩÂä† -->
                            <div style="margin: 0.25rem 0;">
                                {% if booking.customer.is_first_visit %}
                                    <span class="badge" style="background: #28a745; color: white; font-size: 0.7rem;">ÂàùÂõû</span>
                                {% else %}
                                    <span class="badge" style="background: #6c757d; color: white; font-size: 0.7rem;">„É™„Éî„Éº„Éà</span>
                                {% endif %}
                            </div>
                            
                            <!-- ÈÄ£Áµ°ÂÖàÊÉÖÂ†± -->
                            <small>{{ booking.customer.email }}</small><br>
                            <small>{{ booking.customer.phone }}</small>
                        </td>
                        <td>{{ booking.service.name }}</td>
                        <td>¬•{{ booking.service.price|floatformat:0 }}</td>
                        <td>
                            {% if booking.status == 'pending' %}
                                <span class="badge badge-pending">Áî≥Ëæº‰∏≠</span>
                            {% elif booking.status == 'confirmed' %}
                                <span class="badge badge-confirmed">Á¢∫ÂÆö</span>
                            {% elif booking.status == 'completed' %}
                                <span class="badge badge-completed">ÂÆå‰∫Ü</span>
                            {% elif booking.status == 'cancelled' %}
                                <span class="badge badge-cancelled">„Ç≠„É£„É≥„Çª„É´</span>
                            {% elif booking.status == 'no_show' %}
                                <span class="badge badge-no-show">ÁÑ°Êñ≠„Ç≠„É£„É≥„Çª„É´</span>
                            {% endif %}
                        </td>
                        <td>{{ booking.created_at|date:"m/d H:i" }}</td>
                        <td>
                            <a href="{% url 'dashboard:booking_detail' booking.id %}" 
                               class="btn btn-sm btn-primary">Ë©≥Á¥∞</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="text-align: center; color: #666; padding: 3rem;">
                {% if current_status or current_date %}
                    ÊåáÂÆö„Åó„ÅüÊù°‰ª∂„Å´Ë©≤ÂΩì„Åô„Çã‰∫àÁ¥Ñ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ
                {% else %}
                    „Åæ„Å†‰∫àÁ¥Ñ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ
                {% endif %}
            </p>
        {% endif %}
    </div>
</div>

<!-- ‚òÖ Êñ∞Ë¶èËøΩÂä†: ÊÄßÂà•„ÉªÂà©Áî®Áä∂Ê≥ÅÁµ±Ë®à -->
<div class="card">
    <div class="card-header">
        <h3>‰∫àÁ¥ÑÁµ±Ë®àÔºàË°®Á§∫‰∏≠„ÅÆ‰∫àÁ¥ÑÔºâ</h3>
    </div>
    <div class="card-body">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ bookings.count }}</div>
                <div class="stat-label">Á∑è‰∫àÁ¥ÑÊï∞</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">
                    {% with male_bookings=0 %}
                        {% for booking in bookings %}
                            {% if booking.customer.gender == 'male' %}
                                {% with male_bookings=male_bookings|add:1 %}{% endwith %}
                            {% endif %}
                        {% endfor %}
                        {% for booking in bookings %}
                            {% if booking.customer.gender == 'male' and forloop.last %}
                                {{ forloop.counter0|add:1 }}
                            {% endif %}
                        {% endfor %}
                    {% endwith %}
                </div>
                <div class="stat-label">üë® Áî∑ÊÄß„ÅÆ‰∫àÁ¥Ñ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">
                    {% with female_bookings=0 %}
                        {% for booking in bookings %}
                            {% if booking.customer.gender == 'female' %}
                                {% with female_bookings=female_bookings|add:1 %}{% endwith %}
                            {% endif %}
                        {% endfor %}
                        {% for booking in bookings %}
                            {% if booking.customer.gender == 'female' and forloop.last %}
                                {{ forloop.counter0|add:1 }}
                            {% endif %}
                        {% endfor %}
                    {% endwith %}
                </div>
                <div class="stat-label">üë© Â•≥ÊÄß„ÅÆ‰∫àÁ¥Ñ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">
                    {% with first_visit_bookings=0 %}
                        {% for booking in bookings %}
                            {% if booking.customer.is_first_visit %}
                                {% with first_visit_bookings=first_visit_bookings|add:1 %}{% endwith %}
                            {% endif %}
                        {% endfor %}
                        {% for booking in bookings %}
                            {% if booking.customer.is_first_visit and forloop.last %}
                                {{ forloop.counter0|add:1 }}
                            {% endif %}
                        {% endfor %}
                    {% endwith %}
                </div>
                <div class="stat-label">ÂàùÂõûÂà©Áî®„ÅÆ‰∫àÁ¥Ñ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">
                    {% with pending_bookings=0 %}
                        {% for booking in bookings %}
                            {% if booking.status == 'pending' %}
                                {% with pending_bookings=pending_bookings|add:1 %}{% endwith %}
                            {% endif %}
                        {% endfor %}
                        {% for booking in bookings %}
                            {% if booking.status == 'pending' and forloop.last %}
                                {{ forloop.counter0|add:1 }}
                            {% endif %}
                        {% endfor %}
                    {% endwith %}
                </div>
                <div class="stat-label">Áî≥Ëæº‰∏≠„ÅÆ‰∫àÁ¥Ñ</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">
                    {% with confirmed_bookings=0 %}
                        {% for booking in bookings %}
                            {% if booking.status == 'confirmed' %}
                                {% with confirmed_bookings=confirmed_bookings|add:1 %}{% endwith %}
                            {% endif %}
                        {% endfor %}
                        {% for booking in bookings %}
                            {% if booking.status == 'confirmed' and forloop.last %}
                                {{ forloop.counter0|add:1 }}
                            {% endif %}
                        {% endfor %}
                    {% endwith %}
                </div>
                <div class="stat-label">Á¢∫ÂÆöÊ∏à„Åø‰∫àÁ¥Ñ</div>
            </div>
        </div>
    </div>
</div>

<!-- ‚òÖ Êñ∞Ë¶èËøΩÂä†: Ë°®Á§∫„ÅÆË™¨Êòé -->
<div class="card">
    <div class="card-header">
        <h3>üí° ‰∫àÁ¥Ñ‰∏ÄË¶ß„ÅÆË¶ãÊñπ</h3>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                <h5 style="margin-bottom: 0.5rem;">ÊÄßÂà•„Ç¢„Ç§„Ç≥„É≥</h5>
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                    <span style="font-size: 16px; color: #007bff;">üë®</span>
                    <span>Áî∑ÊÄß„ÅÆ„ÅäÂÆ¢Êßò</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                    <span style="font-size: 16px; color: #e91e63;">üë©</span>
                    <span>Â•≥ÊÄß„ÅÆ„ÅäÂÆ¢Êßò</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 14px; color: #6c757d;">‚ùì</span>
                    <span>ÊÄßÂà•Êú™Ë®≠ÂÆö</span>
                </div>
            </div>
            <div style="padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                <h5 style="margin-bottom: 0.5rem;">Âà©Áî®Áä∂Ê≥Å„Éê„ÉÉ„Ç∏</h5>
                <div style="margin-bottom: 0.5rem;">
                    <span class="badge" style="background: #28a745; color: white; font-size: 0.7rem;">ÂàùÂõû</span>
                    <span style="margin-left: 0.5rem;">ÂàùÂõûÂà©Áî®„ÅÆ„ÅäÂÆ¢Êßò</span>
                </div>
                <div>
                    <span class="badge" style="background: #6c757d; color: white; font-size: 0.7rem;">„É™„Éî„Éº„Éà</span>
                    <span style="margin-left: 0.5rem;">„É™„Éî„Éº„ÉàÂà©Áî®„ÅÆ„ÅäÂÆ¢Êßò</span>
                </div>
            </div>
        </div>
        <p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
            ‚Äª ÊÄßÂà•„ÅØ‰∫àÁ¥ÑÊôÇ„ÅÆÈÅ∏ÊäûÊÉÖÂ†±„Åß„Åô„ÄÇÁÆ°ÁêÜÁîªÈù¢„Åã„ÇâÊúÄÁµÇÂà§Êñ≠„Åß„ÅÆÂ§âÊõ¥„ÅåÂèØËÉΩ„Åß„Åô„ÄÇ
        </p>
    </div>
</div>
{% endblock %}