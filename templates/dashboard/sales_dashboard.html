{% extends 'dashboard/base_dashboard.html' %}

{% block title %}{{ title }}{% endblock %}
{% block page_title %}ğŸ’° å£²ä¸Šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰{% endblock %}

{% block content %}
<!-- â˜… æ–°æ©Ÿèƒ½: æœˆé¸æŠæ©Ÿèƒ½ -->
<div class="card">
    <div class="card-header">
        <h3>ğŸ“… è¡¨ç¤ºæœˆé¸æŠ</h3>
    </div>
    <div class="card-body">
        <div class="month-selector">
            <select id="monthSelector" class="form-control">
                {% for month_data in available_months %}
                <option value="{{ month_data.year }}-{{ month_data.month }}" 
                        {% if month_data.is_selected %}selected{% endif %}>
                    {{ month_data.display }}
                    {% if month_data.year == selected_year and month_data.month == selected_month and is_current_month %}
                        ï¼ˆç¾åœ¨ï¼‰
                    {% endif %}
                </option>
                {% endfor %}
            </select>
            <div class="month-navigation">
                <!-- å‰æœˆãƒ»æ¬¡æœˆãƒœã‚¿ãƒ³ã¯JavaScriptã§å®Ÿè£… -->
                <button id="prevMonthBtn" class="btn btn-secondary btn-sm">â† å‰æœˆ</button>
                <button id="nextMonthBtn" class="btn btn-secondary btn-sm">æ¬¡æœˆ â†’</button>
            </div>
        </div>
    </div>
</div>

<!-- å£²ä¸Šã‚µãƒãƒªãƒ¼ -->
<div class="card">
    <div class="card-header">
        <h3>ğŸ“Š {{ current_month }}ã®å£²ä¸Šã‚µãƒãƒªãƒ¼</h3>
        {% if not is_current_month %}
        <small style="color: #666;">éå»ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­</small>
        {% endif %}
    </div>
    <div class="card-body">
        <div class="stats-grid">
            <div class="stat-card highlight">
                <div class="stat-number">Â¥{{ summary_stats.total_revenue|floatformat:0 }}</div>
                <div class="stat-label">{{ current_month }}ã®å£²ä¸Š</div>
                {% if summary_stats.revenue_growth != 0 %}
                <div class="stat-growth {% if summary_stats.revenue_growth > 0 %}positive{% else %}negative{% endif %}">
                    {% if summary_stats.revenue_growth > 0 %}â†—{% else %}â†˜{% endif %} {{ summary_stats.revenue_growth }}%
                </div>
                {% endif %}
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ summary_stats.total_bookings }}</div>
                <div class="stat-label">{{ current_month }}ã®äºˆç´„æ•°</div>
                {% if summary_stats.booking_growth != 0 %}
                <div class="stat-growth {% if summary_stats.booking_growth > 0 %}positive{% else %}negative{% endif %}">
                    {% if summary_stats.booking_growth > 0 %}â†—{% else %}â†˜{% endif %} {{ summary_stats.booking_growth }}%
                </div>
                {% endif %}
            </div>
            <div class="stat-card">
                <div class="stat-number">Â¥{{ summary_stats.avg_price|floatformat:0 }}</div>
                <div class="stat-label">å¹³å‡å®¢å˜ä¾¡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">Â¥{{ summary_stats.avg_daily_revenue|floatformat:0 }}</div>
                <div class="stat-label">1æ—¥å¹³å‡å£²ä¸Š</div>
            </div>
        </div>
        
        <!-- å‰æœˆæ¯”è¼ƒ -->
        <div class="comparison-section">
            <h4>ğŸ“ˆ å‰æœˆï¼ˆ{{ last_month }}ï¼‰ã¨ã®æ¯”è¼ƒ</h4>
            <div class="comparison-grid">
                <div class="comparison-item">
                    <span class="label">å‰æœˆå£²ä¸Š:</span>
                    <span class="value">Â¥{{ summary_stats.last_month_revenue|floatformat:0 }}</span>
                </div>
                <div class="comparison-item">
                    <span class="label">å‰æœˆäºˆç´„æ•°:</span>
                    <span class="value">{{ summary_stats.last_month_bookings }}ä»¶</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
    <!-- æœˆåˆ¥å£²ä¸Šæ¨ç§» -->
    <div class="card">
        <div class="card-header">
            <h3>ğŸ“ˆ æœˆåˆ¥å£²ä¸Šæ¨ç§»ï¼ˆéå»12ãƒ¶æœˆï¼‰</h3>
        </div>
        <div class="card-body">
            <canvas id="monthlyRevenueChart" width="400" height="200"></canvas>
        </div>
    </div>
    
    <!-- ä»Šæœˆã®æ—¥åˆ¥å£²ä¸Š -->
    <div class="card">
        <div class="card-header">
            <h3>ğŸ“… {{ current_month }}æ—¥åˆ¥å£²ä¸Š</h3>
        </div>
        <div class="card-body">
            <canvas id="dailyRevenueChart" width="400" height="200"></canvas>
        </div>
    </div>
</div>

<!-- ã‚µãƒ¼ãƒ“ã‚¹åˆ¥å£²ä¸Š & ã‚»ãƒ©ãƒ”ã‚¹ãƒˆåˆ¥å£²ä¸Š -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
    <!-- ã‚µãƒ¼ãƒ“ã‚¹åˆ¥å£²ä¸Š -->
    <div class="card">
        <div class="card-header">
            <h3>ğŸ›ï¸ ã‚µãƒ¼ãƒ“ã‚¹åˆ¥å£²ä¸Šï¼ˆ{{ current_month }}ï¼‰</h3>
        </div>
        <div class="card-body">
            {% if service_sales %}
                <div class="service-sales-list">
                    {% for service in service_sales %}
                    <div class="service-item">
                        <div class="service-info">
                            <div class="service-name">{{ service.service__name }}</div>
                            <div class="service-details">
                                {{ service.count }}å› Ã— Â¥{{ service.service__price|floatformat:0 }}
                            </div>
                        </div>
                        <div class="service-revenue">Â¥{{ service.total|floatformat:0 }}</div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- ã‚µãƒ¼ãƒ“ã‚¹åˆ¥å††ã‚°ãƒ©ãƒ• -->
                <div style="margin-top: 2rem;">
                    <canvas id="serviceRevenueChart" width="300" height="150"></canvas>
                </div>
            {% else %}
                <p style="text-align: center; color: #666; padding: 2rem;">
                    {{ current_month }}ã¯å®Œäº†ã—ãŸäºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
                </p>
            {% endif %}
        </div>
    </div>
    
    <!-- ã‚»ãƒ©ãƒ”ã‚¹ãƒˆåˆ¥å£²ä¸Š -->
    <div class="card">
        <div class="card-header">
            <h3>ğŸ’†â€â™€ï¸ ã‚»ãƒ©ãƒ”ã‚¹ãƒˆåˆ¥å£²ä¸Šï¼ˆ{{ current_month }}ï¼‰</h3>
        </div>
        <div class="card-body">
            {% if therapist_sales %}
                <div class="therapist-sales-list">
                    {% for therapist in therapist_sales %}
                    <div class="therapist-item">
                        <div class="therapist-info">
                            <div class="therapist-name">{{ therapist.therapist__display_name }}</div>
                            <div class="therapist-details">{{ therapist.count }}ä»¶ã®æ–½è¡“</div>
                        </div>
                        <div class="therapist-revenue">Â¥{{ therapist.total|floatformat:0 }}</div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p style="text-align: center; color: #666; padding: 2rem;">
                    {{ current_month }}ã¯ã‚»ãƒ©ãƒ”ã‚¹ãƒˆæŒ‡åã®å®Œäº†äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
                </p>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        border: 2px solid #e9ecef;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .stat-card.highlight {
        background: linear-gradient(135deg, #8b7355 0%, #d4c4a8 100%);
        color: white;
        border-color: #8b7355;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    .stat-growth {
        font-size: 0.9rem;
        font-weight: bold;
        margin-top: 0.5rem;
    }
    
    .stat-growth.positive {
        color: #28a745;
    }
    
    .stat-growth.negative {
        color: #dc3545;
    }
    
    .comparison-section {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e9ecef;
    }
    
    .comparison-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .comparison-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .comparison-item .label {
        font-weight: 500;
        color: #666;
    }
    
    .comparison-item .value {
        font-weight: bold;
        color: #333;
    }
    
    .service-sales-list, .therapist-sales-list {
        space-y: 1rem;
    }
    
    .service-item, .therapist-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 0.75rem;
    }
    
    .service-name, .therapist-name {
        font-weight: bold;
        color: #333;
    }
    
    .service-details, .therapist-details {
        font-size: 0.9rem;
        color: #666;
    }
    
    .service-revenue,     .therapist-revenue {
        font-weight: bold;
        font-size: 1.1rem;
        color: #8b7355;
    }
    
    /* â˜… æ–°æ©Ÿèƒ½: æœˆé¸æŠæ©Ÿèƒ½ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .month-selector {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .month-selector select {
        min-width: 200px;
        padding: 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        background: white;
        transition: border-color 0.3s;
    }
    
    .month-selector select:focus {
        outline: none;
        border-color: #8b7355;
        box-shadow: 0 0 5px rgba(139, 115, 85, 0.3);
    }
    
    .month-navigation {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .month-navigation .btn {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        border-radius: 20px;
    }
    
    @media (max-width: 768px) {
        .month-selector {
            flex-direction: column;
            align-items: stretch;
        }
        
        .month-selector select {
            min-width: 100%;
        }
    }
</style>

<!-- Chart.js ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // â˜… æ–°æ©Ÿèƒ½: æœˆé¸æŠæ©Ÿèƒ½
    const monthSelector = document.getElementById('monthSelector');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    
    if (monthSelector) {
        monthSelector.addEventListener('change', function() {
            const selectedValue = this.value;
            const [year, month] = selectedValue.split('-');
            
            // URL ã‚’æ›´æ–°ã—ã¦ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
            const newUrl = `${window.location.pathname}?year=${year}&month=${month}`;
            window.location.href = newUrl;
        });
        
        // å‰æœˆãƒ»æ¬¡æœˆãƒœã‚¿ãƒ³ã®è¨­å®š
        const options = Array.from(monthSelector.options);
        const selectedIndex = monthSelector.selectedIndex;
        
        // å‰æœˆãƒœã‚¿ãƒ³
        if (prevMonthBtn) {
            if (selectedIndex < options.length - 1) {
                const prevOption = options[selectedIndex + 1];
                const [prevYear, prevMonth] = prevOption.value.split('-');
                prevMonthBtn.onclick = function() {
                    window.location.href = `${window.location.pathname}?year=${prevYear}&month=${prevMonth}`;
                };
                prevMonthBtn.disabled = false;
            } else {
                prevMonthBtn.disabled = true;
            }
        }
        
        // æ¬¡æœˆãƒœã‚¿ãƒ³
        if (nextMonthBtn) {
            if (selectedIndex > 0) {
                const nextOption = options[selectedIndex - 1];
                const [nextYear, nextMonth] = nextOption.value.split('-');
                nextMonthBtn.onclick = function() {
                    window.location.href = `${window.location.pathname}?year=${nextYear}&month=${nextMonth}`;
                };
                nextMonthBtn.disabled = false;
            } else {
                nextMonthBtn.disabled = true;
            }
        }
    }
    
    // æœˆåˆ¥å£²ä¸Šæ¨ç§»ã‚°ãƒ©ãƒ•
    const monthlyCtx = document.getElementById('monthlyRevenueChart').getContext('2d');
    new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: [{% for month in monthly_sales %}'{{ month.month_short }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'å£²ä¸Šï¼ˆå††ï¼‰',
                data: [{% for month in monthly_sales %}{{ month.revenue }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: '#8b7355',
                backgroundColor: 'rgba(139, 115, 85, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'Â¥' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // æ—¥åˆ¥å£²ä¸Šã‚°ãƒ©ãƒ•
    const dailyCtx = document.getElementById('dailyRevenueChart').getContext('2d');
    new Chart(dailyCtx, {
        type: 'bar',
        data: {
            labels: [{% for day in daily_sales %}'{{ day.date }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: 'å£²ä¸Šï¼ˆå††ï¼‰',
                data: [{% for day in daily_sales %}{{ day.revenue }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: [{% for day in daily_sales %}{% if day.is_today %}'rgba(139, 115, 85, 0.8)'{% else %}'rgba(139, 115, 85, 0.6)'{% endif %}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: '#8b7355',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'Â¥' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    {% if service_sales %}
    // ã‚µãƒ¼ãƒ“ã‚¹åˆ¥å††ã‚°ãƒ©ãƒ•
    const serviceCtx = document.getElementById('serviceRevenueChart').getContext('2d');
    new Chart(serviceCtx, {
        type: 'doughnut',
        data: {
            labels: [{% for service in service_sales %}'{{ service.service__name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for service in service_sales %}{{ service.total }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: [
                    'rgba(139, 115, 85, 0.8)',
                    'rgba(212, 196, 168, 0.8)',
                    'rgba(139, 115, 85, 0.6)',
                    'rgba(212, 196, 168, 0.6)',
                    'rgba(139, 115, 85, 0.4)',
                    'rgba(212, 196, 168, 0.4)'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    {% endif %}
});
</script>
{% endblock %}